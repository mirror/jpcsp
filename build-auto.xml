<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="build" name="Jpcsp">
	<property environment="env" />
	<property name="debuglevel" value="source,lines,vars" />
	<property name="target" value="1.6" />
	<property name="source" value="1.6" />
	<property name="source.encoding" value="UTF-8" />

	<property name="jpcsp.mainclass" value="jpcsp.MainGUI" />
	<property name="jpcsp.version" value="0.7" />

	<path id="Jpcsp.classpath">
		<pathelement location="lib/jinput.jar" />
		<pathelement location="lib/lwjgl_util.jar" />
		<pathelement location="lib/lwjgl.jar" />
		<pathelement location="lib/javassist.jar" />
		<pathelement location="lib/jgz-0.2.jar" />
		<pathelement location="lib/jide-oss-2.8.4.jar" />
		<pathelement location="lib/log4j-1.2.15.jar" />
		<pathelement location="lib/asm-all-4.0_RC1.jar" />
		<pathelement location="lib/jaxen-1.1.1.jar" />
		<pathelement location="lib/jdom1.1.jar" />
		<pathelement location="lib/xuggle-xuggler-noarch-5.4.jar" />
		<pathelement location="lib/commons-cli.jar" />
		<pathelement location="lib/logback-classic.jar" />
		<pathelement location="lib/logback-core.jar" />
		<pathelement location="lib/slf4j-api.jar" />
		<pathelement location="lib/bcprov-jdk16-145.jar" />
	</path>

	<macrodef name="svnversion" description="Get last subversion commit version.">
		<attribute name="dir" default="" />
		<attribute name="outputproperty" />
		<attribute name="unversionedDefault" default="" />
		<attribute name="failonerror" default="true" />
		<sequential>
			<exec outputproperty="@{outputproperty}" executable="svnversion" failonerror="@{failonerror}" failifexecutionfails="@{failonerror}">
				<arg line="-n -c @{dir}" />
				<redirector>
					<outputfilterchain>
						<tokenfilter>
							<replaceregex pattern="^[0-9]*:" replace="" flags="g" />
							<replaceregex pattern="exported" replace="@{unversionedDefault}" flags="g" />
						</tokenfilter>
					</outputfilterchain>
				</redirector>
			</exec>
		</sequential>
	</macrodef>
	
	<macrodef name="szip" description="Compress the build with 7-zip.">
		<attribute name="dir" default="dist" />
		<attribute name="platform.name" />
		<attribute name="basedir" default="jpcsp-@{platform.name}" />
		<sequential>
			<svnversion outputproperty="jpcsp.revision" />
			<exec executable="7z" dir="@{dir}">
				<arg line="a -t7z -m0=lzma -mx=9 -mfb=64 -md=8m -ms=on" />
				<arg line="jpcsp-${jpcsp.revision}-@{platform.name}.7z" />
				<arg line="@{basedir}" />
			</exec>
		</sequential>
	</macrodef>

	<target name="init">
		<mkdir dir="bin/class" />
		<copy includeemptydirs="false" todir="bin/class">
			<fileset dir="src">
				<exclude name="**/*.launch" />
				<exclude name="**/*.java" />
				<exclude name="**/*.awk" />
				<exclude name="**/*.disabled" />
				<exclude name="**/*.form" />
			</fileset>
		</copy>
	</target>
	<target name="clean">
		<delete dir="bin" />
	</target>
	<target depends="clean" name="cleanall">
		<delete dir="dist" />
	</target>
	<target depends="build-subprojects,build-project" name="build" />
	<target name="build-subprojects" />
	<target depends="init" name="build-project">
		<echo message="${ant.project.name}: ${ant.file}" />
		<javac debug="true" debuglevel="${debuglevel}" destdir="bin/class" source="${source}" encoding="${source.encoding}" target="${target}">
			<src path="src" />
			<classpath refid="Jpcsp.classpath" />
		</javac>
	</target>
	<target description="Build all projects which reference this project. Useful to propagate changes." name="build-refprojects" />
	<target name="run">
		<java classname="${jpcsp.mainclass}" failonerror="true" fork="yes">
			<jvmarg value="-Xmx512m" />
			<jvmarg value="-Djava.library.path=lib/windows-x86" />
			<classpath refid="Jpcsp.classpath" />
		</java>
	</target>
	<target depends="build" name="jar">
		<manifestclasspath property="jar.classpath" jarfile="bin/jpcsp.jar">
			<classpath refid="Jpcsp.classpath" />
		</manifestclasspath>
		<exec executable="svnversion" output="bin/class/jpcsp/title.txt" failifexecutionfails="no">
			<arg value="-n" />
		</exec>
		<jar destfile="bin/jpcsp.jar" basedir="bin/class">
			<manifest>
				<attribute name="Main-Class" value="${jpcsp.mainclass}" />
				<attribute name="Class-Path" value="${jar.classpath}" />
			</manifest>
		</jar>
	</target>
	<target depends="dist-windows-x86,dist-windows-amd64,dist-linux-x86,dist-linux-amd64,dist-macosx" name="dist" />
	<target depends="jar" name="dist-generic">
		<delete dir="dist/jpcsp-${platform.name}" />
		<mkdir dir="dist/jpcsp-${platform.name}" />
		<copy todir="dist/jpcsp-${platform.name}">
			<fileset dir="">
				<include name="bin/jpcsp.jar" />
				<include name="lib/*.jar" />
				<include name="lib/${platform.name}/**" />
				<include name="plugins/${platform.name}/**" />
				<include name="plugins/README.txt" />
				<include name="demos/**" />
				<include name="flash0/**" />
				<include name="ms0/**" />
				<include name="patches/**" />
				<include name="umdimages/**" />
				<include name="gpl.txt" />
				<include name="README.txt" />
				<include name="Compiler.xml" />
				<include name="LogSettings.xml" />
				<include name="start-${platform.name}*" />
				<exclude name="**/src/**" />
			</fileset>
		</copy>
	</target>
	<target name="dist-windows-x86">
		<antcall target="dist-generic">
			<param name="platform.name" value="windows-x86" />
		</antcall>
		<szip platform.name="windows-x86" />
	</target>
	<target name="dist-windows-amd64">
		<antcall target="dist-generic">
			<param name="platform.name" value="windows-amd64" />
			<reference refid="Jpcsp.classpath" />
		</antcall>
		<szip platform.name="windows-amd64" />
	</target>
	<target name="dist-linux-x86">
		<antcall target="dist-generic">
			<param name="platform.name" value="linux-x86" />
		</antcall>
		<szip platform.name="linux-x86" />
	</target>
	<target name="dist-linux-amd64">
		<antcall target="dist-generic">
			<param name="platform.name" value="linux-amd64" />
		</antcall>
		<szip platform.name="linux-amd64" />
	</target>
	<target name="dist-macosx">
		<antcall target="dist-generic">
			<param name="platform.name" value="macosx" />
		</antcall>
		<mkdir dir="dist/jpcsp-macosx/Jpcsp.app" />
		<copy todir="dist/jpcsp-macosx/Jpcsp.app">
			<fileset dir="distsupport/macosx">
				<include name="**" />
				<exclude name="Contents/Info.plist" />
			</fileset>
		</copy>
		<pathconvert property="jpcsp.libraries" dirsep="/" pathsep="&lt;/string>${line.separator}&#x0009;&#x0009;&#x0009;&lt;string>">
			<map from="${basedir}" to="$JAVAROOT"/>
			<path location="${basedir}/bin/jpcsp.jar" />
			<path refid="Jpcsp.classpath" />
		</pathconvert>
		<svnversion outputproperty="jpcsp.revision" />
		<copy file="distsupport/macosx/Contents/Info.plist"
			tofile="dist/jpcsp-macosx/Jpcsp.app/Contents/Info.plist" >
			<filterchain>
				<replacetokens>
					<token key="major.version" value="${jpcsp.version}" />
					<token key="minor.version" value="${jpcsp.revision}" />
					<token key="libraries" value="${jpcsp.libraries}" />
				</replacetokens>
			</filterchain>
		</copy>
		<move todir="dist/jpcsp-macosx/Jpcsp.app/Contents/Resources/Java">
			<fileset dir="dist/jpcsp-macosx">
				<include name="**" />
				<exclude name="Jpcsp.app/**" />
			</fileset>
		</move>
		<tar destfile="dist/jpcsp-${jpcsp.revision}-macosx.tar">
			<tarfileset dir="dist/jpcsp-macosx" filemode="755">
				<include name="Jpcsp.app/Contents/MacOS/JavaApplicationStub"/>
			</tarfileset>
			<tarfileset dir="dist/jpcsp-macosx">
				<include name="**" />
				<exclude name="Jpcsp.app/Contents/MacOS/JavaApplicationStub"/>
			</tarfileset>
		</tar>
		<szip platform.name="macosx" basedir="jpcsp-${jpcsp.revision}-macosx.tar" />
		<delete file="dist/jpcsp-${jpcsp.revision}-macosx.tar" />
	</target>
</project>
